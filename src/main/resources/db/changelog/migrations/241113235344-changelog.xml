<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">


    <changeSet id="1731538424026-1" author="gkhaavik">
        <sql>
            UPDATE product_variants pv
                INNER JOIN (
                SELECT sku, GROUP_CONCAT(id) as ids
                FROM product_variants
                GROUP BY sku
                HAVING COUNT(id) > 1
                ) duplicates ON pv.sku = duplicates.sku
                SET pv.sku = CONCAT(pv.sku, '-', FIND_IN_SET(pv.id, duplicates.ids));
        </sql>

        <addUniqueConstraint columnNames="sku" constraintName="uc_product_variants_sku" tableName="product_variants"/>
    </changeSet>

</databaseChangeLog>